<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>呼吸器外科専門医 更新管理</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 1rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:active { background: #1d4ed8; }
        .btn-secondary { background: white; border: 1px solid #d1d5db; }
        .btn-secondary:active { background: #f9fafb; }
        .tabs { display: flex; border-bottom: 1px solid #e5e7eb; overflow-x: auto; }
        .tab { padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; white-space: nowrap; font-size: 0.875rem; color: #6b7280; border-bottom: 2px solid transparent; }
        .tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .badge-complete { background: #dcfce7; border: 2px solid #22c55e; padding: 1rem; border-radius: 0.5rem; }
        .badge-incomplete { background: #fef3c7; border: 2px solid #eab308; padding: 1rem; border-radius: 0.5rem; }
        .badge-number { font-size: 1.5rem; font-weight: bold; }
        .item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .item-content { flex: 1; min-width: 0; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 50; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 0.5rem; padding: 1.5rem; max-width: 28rem; width: 100%; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
        .form-input, .form-select { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
        .grid { display: grid; gap: 0.75rem; }
        @media (min-width: 768px) { .grid-2 { grid-template-columns: repeat(2, 1fr); } }
        .text-blue { color: #2563eb; }
        .text-green { color: #22c55e; }
        .text-yellow { color: #eab308; }
        .text-gray { color: #6b7280; }
        .font-bold { font-weight: bold; }
        .mb-4 { margin-bottom: 1rem; }
        .flex { display: flex; }
        .gap-2 { gap: 0.5rem; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .badge-tag { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: 0.5rem; }
        .badge-a { background: #fee2e2; color: #dc2626; font-weight: 600; }
        .badge-b { background: #fef3c7; color: #d97706; font-weight: 600; }
        .badge-basic { background: #dcfce7; color: #16a34a; font-weight: 600; }
        .badge-unit { background: #dbeafe; color: #2563eb; font-weight: 600; }
        .badge-gakkai { background: #f3e8ff; color: #9333ea; font-weight: 600; }
        .badge-seminar { background: #fce7f3; color: #db2777; font-weight: 600; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const defaultSettings = { acquisitionYear: 2024, acquisitionMonth: 1 };
        const savedSettings = JSON.parse(localStorage.getItem('cert-tracker-settings') || JSON.stringify(defaultSettings));
        const data = JSON.parse(localStorage.getItem('cert-tracker-data') || '{"surgeries":[],"conferences":[],"safetyTraining":[],"publications":[],"presentations":[],"chairmanships":[],"seminars":[]}');
        let activeTab = 'overview';
        let modalType = '';
        let settings = savedSettings;

        function saveData() {
            localStorage.setItem('cert-tracker-data', JSON.stringify(data));
            render();
        }

        function saveSettings() {
            localStorage.setItem('cert-tracker-settings', JSON.stringify(settings));
            render();
        }

        function getExpirationDate() {
            const year = parseInt(settings.acquisitionYear) + 5;
            const month = parseInt(settings.acquisitionMonth);
            return `${year}年${month}月`;
        }

        function getAcquisitionDate() {
            return `${settings.acquisitionYear}年${settings.acquisitionMonth}月`;
        }

        function calc() {
            const surgeriesForBasic = data.surgeries.filter(s => s.usedInBasic).length;
            const surgeryGroupA = data.surgeries.filter(s => s.usedInBasic && s.group === 'A群').length;
            const surgeryGroupB = data.surgeries.filter(s => s.usedInBasic && s.group === 'B群').length;
            
            const used = data.conferences.filter(c => c.usedInBasic && c.confType === '学会');
            const main = used.filter(c => ['呼吸器外科学会', '胸部外科学会'].includes(c.type)).length;
            const regional = used.filter(c => ['地方会', 'ACCP'].includes(c.type)).length;
            const national = used.filter(c => c.type === '全国学会').length;
            const confMain = main + national + Math.floor(regional / 2);
            const confSurgical = used.filter(c => c.type === '外科学会').length;
            const publicationsForBasic = data.publications.filter(p => p.usedInBasic).length;
            
            let units = 0;
            units += Math.floor(data.surgeries.filter(s => !s.usedInBasic).length / 5);
            units += data.publications.filter(p => !p.usedInBasic).length * 5;
            units += data.presentations.filter(p => p.useForUnits).length;
            units += data.chairmanships.length;
            data.seminars.forEach(s => units += (s.type === '地域' && s.role === '講師') ? 0.5 : 1);
            
            return { surgeriesForBasic, surgeryGroupA, surgeryGroupB, confMain, confSurgical, safetyCount: data.safetyTraining.length, publicationsForBasic, units };
        }

        function openModal(type) {
            modalType = type;
            document.getElementById('modal').classList.add('show');
            document.getElementById('modalForm').reset();
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        function submitForm(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const obj = {};
            formData.forEach((value, key) => {
                if (key === 'useForUnits') {
                    obj[key] = value === 'true';
                } else {
                    obj[key] = value;
                }
            });
            
            if (modalType === 'surgery') data.surgeries.push({...obj, usedInBasic: false});
            else if (modalType === 'conference') data.conferences.push({...obj, usedInBasic: false});
            else if (modalType === 'safety') data.safetyTraining.push(obj);
            else if (modalType === 'publication') data.publications.push({...obj, usedInBasic: false});
            else if (modalType === 'presentation') data.presentations.push(obj);
            else if (modalType === 'chairman') data.chairmanships.push(obj);
            else if (modalType === 'seminar') data.seminars.push(obj);
            
            saveData();
            closeModal();
        }

        function deleteItem(category, index) {
            if (confirm('削除しますか？')) {
                data[category].splice(index, 1);
                saveData();
            }
        }

        function toggleBasic(category, index) {
            data[category][index].usedInBasic = !data[category][index].usedInBasic;
            saveData();
        }
        
        function updateSettings(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            settings.acquisitionYear = parseInt(formData.get('acquisitionYear'));
            settings.acquisitionMonth = parseInt(formData.get('acquisitionMonth'));
            saveSettings();
            document.getElementById('settingsSuccess').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('settingsSuccess').classList.add('hidden');
            }, 3000);
        }

        function render() {
            const c = calc();
            const root = document.getElementById('root');
            
            let html = `
                <div class="container">
                    <div class="card">
                        <h1 class="font-bold text-blue" style="font-size:1.5rem;margin-bottom:0.5rem">呼吸器外科専門医 更新管理</h1>
                        <p style="font-size:0.875rem" class="text-gray">取得: ${getAcquisitionDate()} | 更新期限: ${getExpirationDate()}</p>
                    </div>
                    
                    <div class="card" style="padding:0">
                        <div class="tabs">
                            ${['overview','surgery','conference','safety','publication','presentation','chairman','seminar','settings'].map((t,i) => 
                                `<button class="tab ${activeTab===t?'active':''}" onclick="activeTab='${t}';render()">${['概要','手術','学会','安全','論文','発表','座長','セミナー','設定'][i]}</button>`
                            ).join('')}
                        </div>
                    </div>`;

            if (activeTab === 'overview') {
                html += `
                    <div class="card">
                        <h2 class="font-bold text-blue mb-4">基礎条件</h2>
                        <div class="grid grid-2">
                            ${badge(c.surgeriesForBasic, 100, '手術経験')}
                            ${badge(c.confMain, 4, '学会参加')}
                            ${badge(c.confSurgical, 1, '外科学会')}
                            ${badge(c.safetyCount, 2, '医療安全')}
                            ${badge(c.publicationsForBasic, 2, '論文')}
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="font-bold text-blue mb-4">単位条件</h2>
                        ${badge(c.units, 20, '取得単位')}
                        <div style="background:#eff6ff;border-radius:0.375rem;padding:0.75rem;margin-top:1rem;font-size:0.875rem">
                            <div class="font-bold" style="margin-bottom:0.5rem">単位内訳:</div>
                            <div>手術: ${Math.floor(data.surgeries.filter(s => !s.usedInBasic).length / 5)} 単位</div>
                            <div>論文: ${data.publications.filter(p => !p.usedInBasic).length * 5} 単位</div>
                            <div>発表: ${data.presentations.length} 単位</div>
                            <div>座長: ${data.chairmanships.length} 単位</div>
                            <div>セミナー: ${data.seminars.reduce((s,i) => s + ((i.type==='地域' && i.role==='講師') ? 0.5 : 1), 0)} 単位</div>
                        </div>
                    </div>`;
            } else if (activeTab === 'settings') {
                html += `
                    <div class="card">
                        <h2 class="font-bold text-blue mb-4">設定</h2>
                        <div id="settingsSuccess" class="alert alert-success hidden">設定を保存しました</div>
                        <form onsubmit="updateSettings(event)">
                            <div class="form-group">
                                <label class="form-label">専門医取得年</label>
                                <input type="number" name="acquisitionYear" value="${settings.acquisitionYear}" required class="form-input" min="2000" max="2030">
                            </div>
                            <div class="form-group">
                                <label class="form-label">専門医取得月</label>
                                <select name="acquisitionMonth" required class="form-select">
                                    ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${settings.acquisitionMonth === m ? 'selected' : ''}>${m}月</option>`).join('')}
                                </select>
                            </div>
                            <div style="padding:0.75rem;background:#eff6ff;border-radius:0.375rem;margin-bottom:1rem;font-size:0.875rem">
                                <div class="font-bold" style="margin-bottom:0.5rem">更新期限の計算</div>
                                <div>取得: ${settings.acquisitionYear}年${settings.acquisitionMonth}月</div>
                                <div>更新期限: ${parseInt(settings.acquisitionYear) + 5}年${settings.acquisitionMonth}月</div>
                            </div>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </form>
                    </div>`;
            } else if (activeTab === 'surgery') {
                html += `
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-bold text-blue">手術経験</h2>
                            <button class="btn btn-primary" onclick="openModal('surgery')">+ 追加</button>
                        </div>
                        <div style="background:#eff6ff;border-radius:0.375rem;padding:0.75rem;margin-bottom:1rem;font-size:0.875rem">
                            <div>基礎: ${c.surgeriesForBasic} / 100 
                            <div>単位: ${Math.floor(data.surgeries.filter(s => !s.usedInBasic).length / 5)}</div>
                        </div>
                        ${data.surgeries.map((item, i) => `
                            <div class="item">
                                <button onclick="toggleBasic('surgeries',${i})" style="border:none;background:none;padding:0;cursor:pointer">
                                    ${item.usedInBasic ? '✓' : '○'}
                                </button>
                                <div class="item-content">
                                    <div>${item.date} - ${item.role}<span class="badge-tag badge-${item.group === 'A群' ? 'a' : 'b'}">${item.group}</span>${item.usedInBasic ? '<span class="badge-tag badge-basic">基礎</span>' : ''}</div>
                                </div>
                                <button onclick="deleteItem('surgeries',${i})" style="border:none;background:none;color:#dc2626;cursor:pointer">削除</button>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (activeTab === 'conference') {
                html += `
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-bold text-blue">学会参加</h2>
                            <button class="btn btn-primary" onclick="openModal('conference')">+ 追加</button>
                        </div>
                        ${data.conferences.map((item, i) => `
                            <div class="item">
                                <button onclick="toggleBasic('conferences',${i})" style="border:none;background:none;padding:0;cursor:pointer">
                                    ${item.usedInBasic ? '✓' : '○'}
                                </button>
                                <div class="item-content">
                                    <div>${item.name}<span class="badge-tag badge-${item.confType === '学会' ? 'gakkai' : 'seminar'}">${item.confType}</span>${item.usedInBasic ? '<span class="badge-tag badge-basic">基礎</span>' : ''}</div>
                                    <div style="font-size:0.75rem;color:#6b7280">${item.date} [${item.type}]</div>
                                </div>
                                <button onclick="deleteItem('conferences',${i})" style="border:none;background:none;color:#dc2626;cursor:pointer">削除</button>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (activeTab === 'safety') {
                html += `
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-bold text-blue">医療安全研修</h2>
                            <button class="btn btn-primary" onclick="openModal('safety')">+ 追加</button>
                        </div>
                        ${data.safetyTraining.map((item, i) => `
                            <div class="item">
                                <span>✓</span>
                                <div class="item-content">
                                    <div>${item.name}</div>
                                    <div style="font-size:0.75rem;color:#6b7280">${item.date}</div>
                                </div>
                                <button onclick="deleteItem('safetyTraining',${i})" style="border:none;background:none;color:#dc2626;cursor:pointer">削除</button>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (activeTab === 'publication') {
                html += `
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-bold text-blue">論文・著書</h2>
                            <button class="btn btn-primary" onclick="openModal('publication')">+ 追加</button>
                        </div>
                        ${data.publications.map((item, i) => `
                            <div class="item">
                                <button onclick="toggleBasic('publications',${i})" style="border:none;background:none;padding:0;cursor:pointer">
                                    ${item.usedInBasic ? '✓' : '○'}
                                </button>
                                <div class="item-content">
                                    <div>${item.title}${item.usedInBasic ? '<span class="badge-tag badge-basic">基礎</span>' : ''}</div>
                                    <div style="font-size:0.75rem;color:#6b7280">${item.journal} (${item.year})</div>
                                </div>
                                <button onclick="deleteItem('publications',${i})" style="border:none;background:none;color:#dc2626;cursor:pointer">削除</button>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (activeTab === 'presentation') {
                html += `
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-bold text-blue">学会発表</h2>
                            <button class="btn btn-primary" onclick="openModal('presentation')">+ 追加</button>
                        </div>
                        ${data.presentations.map((item, i) => `
                            <div class="item">
                                <span>✓</span>
                                <div class="item-content">
                                    <div>${item.title}<span class="badge-tag badge-${item.useForUnits ? 'unit' : 'basic'}">${item.useForUnits ? '単位' : '基礎'}</span></div>
                                    <div style="font-size:0.75rem;color:#6b7280">${item.conference} (${item.date})</div>
                                </div>
                                <button onclick="deleteItem('presentations',${i})" style="border:none;background:none;color:#dc2626;cursor:pointer">削除</button>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (activeTab === 'chairman') {
                html += `
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-bold text-blue">座長</h2>
                            <button class="btn btn-primary" onclick="openModal('chairman')">+ 追加</button>
                        </div>
                        ${data.chairmanships.map((item, i) => `
                            <div class="item">
                                <span>✓</span>
                                <div class="item-content">
                                    <div>${item.conference}</div>
                                    <div style="font-size:0.75rem;color:#6b7280">${item.date} - ${item.session}</div>
                                </div>
                                <button onclick="deleteItem('chairmanships',${i})" style="border:none;background:none;color:#dc2626;cursor:pointer">削除</button>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (activeTab === 'seminar') {
                html += `
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-bold text-blue">セミナー</h2>
                            <button class="btn btn-primary" onclick="openModal('seminar')">+ 追加</button>
                        </div>
                        ${data.seminars.map((item, i) => `
                            <div class="item">
                                <span>✓</span>
                                <div class="item-content">
                                    <div>${item.name}</div>
                                    <div style="font-size:0.75rem;color:#6b7280">${item.date} - ${item.type} (${item.role})</div>
                                </div>
                                <button onclick="deleteItem('seminars',${i})" style="border:none;background:none;color:#dc2626;cursor:pointer">削除</button>
                            </div>
                        `).join('')}
                    </div>`;
            }

            html += `</div>
                <div id="modal" class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold">項目を追加</h3>
                            <button onclick="closeModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer">×</button>
                        </div>
                        <form id="modalForm" onsubmit="submitForm(event)">
                            ${getFormHtml()}
                            <div class="flex gap-2">
                                <button type="button" onclick="closeModal()" class="btn btn-secondary" style="flex:1">キャンセル</button>
                                <button type="submit" class="btn btn-primary" style="flex:1">追加</button>
                            </div>
                        </form>
                    </div>
                </div>`;

            root.innerHTML = html;
        }

        function badge(current, required, label) {
            const ok = current >= required;
            return `<div class="${ok ? 'badge-complete' : 'badge-incomplete'}">
                <div style="display:flex;align-items:center;gap:0.5rem;font-weight:bold;margin-bottom:0.5rem">
                    <span>${ok ? '✓' : '!'}</span>
                    <span>${label}</span>
                </div>
                <div class="badge-number">${current} / ${required}</div>
                ${!ok ? `<div style="font-size:0.875rem;color:#dc2626;margin-top:0.25rem">あと ${required - current} 必要</div>` : ''}
            </div>`;
        }

        function getFormHtml() {
            if (modalType === 'surgery') return `
                <div class="form-group"><label class="form-label">手術日</label><input name="date" type="date" required class="form-input"></div>
                <div class="form-group"><label class="form-label">役割</label><select name="role" required class="form-select"><option value="">選択</option><option value="術者">術者</option><option value="第1助手">第1助手</option><option value="第2助手">第2助手</option><option value="第3助手">第3助手</option></select></div>
                <div class="form-group"><label class="form-label">分類</label><select name="group" required class="form-select"><option value="">選択</option><option value="A群">A群</option><option value="B群">B群</option></select></div>`;
            if (modalType === 'conference') return `
                <div class="form-group"><label class="form-label">学会名</label><input name="name" type="text" required class="form-input"></div>
                <div class="form-group"><label class="form-label">参加日</label><input name="date" type="date" required class="form-input"></div>
                <div class="form-group"><label class="form-label">区分</label><select name="confType" required class="form-select"><option value="">選択</option><option value="学会">学会</option><option value="セミナー">セミナー</option></select></div>
                <div class="form-group"><label class="form-label">種類</label><select name="type" required class="form-select"><option value="">選択</option><option value="呼吸器外科学会">呼吸器外科学会</option><option value="胸部外科学会">胸部外科学会</option><option value="外科学会">外科学会</option><option value="全国学会">全国学会</option><option value="地方会">地方会</option><option value="ACCP">ACCP</option></select></div>`;
            if (modalType === 'safety') return `
                <div class="form-group"><label class="form-label">研修名</label><input name="name" type="text" required class="form-input"></div>
                <div class="form-group"><label class="form-label">受講日</label><input name="date" type="date" required class="form-input"></div>
                <div class="form-group"><label class="form-label">主催者</label><input name="organizer" type="text" required class="form-input"></div>`;
            if (modalType === 'publication') return `
                <div class="form-group"><label class="form-label">論文タイトル</label><input name="title" type="text" required class="form-input"></div>
                <div class="form-group"><label class="form-label">掲載誌</label><input name="journal" type="text" required class="form-input"></div>
                <div class="form-group"><label class="form-label">掲載年</label><input name="year" type="text" required class="form-input"></div>
                <div class="form-group"><label class="form-label">役割</label><select name="role" required class="form-select"><option value="">選択</option><option value="筆頭">筆頭</option><option value="共著">共著</option></select></div>`;
            if (modalType === 'presentation') return `
                <div class="form-group"><label class="form-label">演題名</label><input name="title" type="text" required class="form-input"></div>
                <div class="form-group"><label class="form-label">学会名</label><input name="conference" type="text" required class="form-input"></div>
                <div class="form-group"><label class="form-label">発表日</label><input name="date" type="date" required class="form-input"></div>
                <div class="form-group"><label class="form-label">役割</label><select name="role" required class="form-select"><option value="">選択</option><option value="演者">演者</option><option value="共同演者">共同演者</option></select></div>
                <div class="form-group"><label class="form-label">カウント方法</label><select name="useForUnits" required class="form-select"><option value="false">基礎条件</option><option value="true">単位条件</option></select></div>`;
            if (modalType === 'chairman') return `
                <div class="form-group"><label class="form-label">学会名</label><input name="conference" type="text" required class="form-input"></div>
                <div class="form-group"><label class="form-label">日付</label><input name="date" type="date" required class="form-input"></div>
                <div class="form-group"><label class="form-label">セッション名</label><input name="session" type="text" required class="form-input"></div>`;
            if (modalType === 'seminar') return `
                <div class="form-group"><label class="form-label">セミナー名</label><input name="name" type="text" required class="form-input"></div>
                <div class="form-group"><label class="form-label">日付</label><input name="date" type="date" required class="form-input"></div>
                <div class="form-group"><label class="form-label">役割</label><select name="role" required class="form-select"><option value="">選択</option><option value="講師">講師</option><option value="受講者">受講者</option></select></div>
                <div class="form-group"><label class="form-label">種別</label><select name="type" required class="form-select"><option value="">選択</option><option value="胸腔鏡">胸腔鏡</option><option value="教育">教育</option><option value="地域">地域</option><option value="アドバンスト">アドバンスト</option></select></div>`;
            return '';
        }

        render();
    </script>
</body>
</html>
